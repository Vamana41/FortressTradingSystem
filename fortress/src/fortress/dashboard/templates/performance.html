{% extends "base.html" %}
{% block content %}
<div class="row g-3">
  <div class="col-12">
    <h4 class="text-light">Performance Monitoring</h4>
  </div>
</div>

<div class="row g-3">
  <div class="col-md-3">
    <div class="card bg-secondary text-light">
      <div class="card-body">
        <h6 class="card-title">System Resources</h6>
        <div class="mb-3">
          <div class="d-flex justify-content-between mb-1">
            <small>CPU Usage</small>
            <span id="cpu-percent">0%</span>
          </div>
          <div class="progress" style="height: 8px;">
            <div id="cpu-progress" class="progress-bar" role="progressbar" style="width: 0%"></div>
          </div>
        </div>
        <div class="mb-3">
          <div class="d-flex justify-content-between mb-1">
            <small>Memory Usage</small>
            <span id="memory-percent">0%</span>
          </div>
          <div class="progress" style="height: 8px;">
            <div id="memory-progress" class="progress-bar bg-info" role="progressbar" style="width: 0%"></div>
          </div>
        </div>
        <div class="mb-3">
          <div class="d-flex justify-content-between mb-1">
            <small>Disk Usage</small>
            <span id="disk-percent">0%</span>
          </div>
          <div class="progress" style="height: 8px;">
            <div id="disk-progress" class="progress-bar bg-warning" role="progressbar" style="width: 0%"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card bg-secondary text-light">
      <div class="card-body">
        <h6 class="card-title">Trading Performance</h6>
        <div class="mb-2">
          <small>Signals/sec:</small>
          <div class="fw-bold" id="signals-per-sec">0.0</div>
        </div>
        <div class="mb-2">
          <small>Orders/sec:</small>
          <div class="fw-bold" id="orders-per-sec">0.0</div>
        </div>
        <div class="mb-2">
          <small>Avg Latency:</small>
          <div class="fw-bold" id="avg-latency">0ms</div>
        </div>
        <div class="mb-2">
          <small>Error Rate:</small>
          <div class="fw-bold" id="error-rate">0%</div>
        </div>
        <div class="mb-2">
          <small>Success Rate:</small>
          <div class="fw-bold" id="success-rate">100%</div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card bg-secondary text-light">
      <div class="card-body">
        <h6 class="card-title">System Info</h6>
        <div class="mb-2">
          <small>Uptime:</small>
          <div class="fw-bold" id="uptime">0h 0m</div>
        </div>
        <div class="mb-2">
          <small>Processes:</small>
          <div class="fw-bold" id="process-count">0</div>
        </div>
        <div class="mb-2">
          <small>Threads:</small>
          <div class="fw-bold" id="thread-count">0</div>
        </div>
        <div class="mb-2">
          <small>Open Files:</small>
          <div class="fw-bold" id="open-files">0</div>
        </div>
        <div class="mb-2">
          <small>Network I/O:</small>
          <div class="fw-bold" id="network-io">0MB</div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card bg-secondary text-light">
      <div class="card-body">
        <h6 class="card-title">Actions</h6>
        <div class="d-grid gap-2">
          <button class="btn btn-primary btn-sm" onclick="refreshMetrics()">
            <i class="bi bi-arrow-clockwise"></i> Refresh
          </button>
          <button class="btn btn-info btn-sm" onclick="runBenchmark()">
            <i class="bi bi-speedometer2"></i> Run Benchmark
          </button>
          <button class="btn btn-warning btn-sm" onclick="saveMetrics()">
            <i class="bi bi-save"></i> Save Metrics
          </button>
          <button class="btn btn-success btn-sm" onclick="exportPerformance()">
            <i class="bi bi-download"></i> Export Data
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row g-3 mt-1">
  <div class="col-md-6">
    <div class="card bg-secondary text-light">
      <div class="card-body">
        <h6 class="card-title">CPU & Memory History</h6>
        <canvas id="systemChart" height="200"></canvas>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card bg-secondary text-light">
      <div class="card-body">
        <h6 class="card-title">Trading Performance History</h6>
        <canvas id="tradingChart" height="200"></canvas>
      </div>
    </div>
  </div>
</div>

<div class="row g-3 mt-1">
  <div class="col-md-12">
    <div class="card bg-secondary text-light">
      <div class="card-body">
        <h6 class="card-title">Recent Benchmarks</h6>
        <div id="benchmarkResults">
          <div class="text-muted">No benchmarks available</div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row g-3 mt-1">
  <div class="col-md-12">
    <div class="card bg-secondary text-light">
      <div class="card-body">
        <h6 class="card-title">Performance Recommendations</h6>
        <div id="recommendations">
          <div class="text-muted">Loading recommendations...</div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let systemChart, tradingChart;
let performanceHistory = [];
let tradingHistory = [];

async function loadPerformanceData() {
  try {
    // Load current performance
    const currentResponse = await fetch('/api/performance/current');
    const currentData = await currentResponse.json();
    updateCurrentMetrics(currentData);

    // Load performance history
    const historyResponse = await fetch('/api/performance/history?hours=6');
    const historyData = await historyResponse.json();
    performanceHistory = historyData.history || [];
    updateCharts();

    // Load benchmark results
    const benchmarkResponse = await fetch('/api/performance/benchmarks?limit=10');
    const benchmarkData = await benchmarkResponse.json();
    updateBenchmarkResults(benchmarkData.benchmarks);

    // Load recommendations
    const summaryResponse = await fetch('/api/performance/summary');
    const summaryData = await summaryResponse.json();
    updateRecommendations(summaryData.recommendations);

  } catch (error) {
    console.error('Failed to load performance data:', error);
    showAlert('Failed to load performance data', 'danger');
  }
}

function updateCurrentMetrics(data) {
  if (!data.system || !data.trading) return;

  // System metrics
  const cpuPercent = data.system.cpu_percent || 0;
  const memoryPercent = data.system.memory_percent || 0;
  const diskPercent = data.system.disk_percent || 0;

  document.getElementById('cpu-percent').textContent = `${cpuPercent.toFixed(1)}%`;
  document.getElementById('memory-percent').textContent = `${memoryPercent.toFixed(1)}%`;
  document.getElementById('disk-percent').textContent = `${diskPercent.toFixed(1)}%`;

  document.getElementById('cpu-progress').style.width = `${cpuPercent}%`;
  document.getElementById('memory-progress').style.width = `${memoryPercent}%`;
  document.getElementById('disk-progress').style.width = `${diskPercent}%`;

  // Update progress bar colors based on thresholds
  updateProgressBarColor('cpu-progress', cpuPercent, 80, 90);
  updateProgressBarColor('memory-progress', memoryPercent, 85, 95);
  updateProgressBarColor('disk-progress', diskPercent, 90, 95);

  // Trading metrics
  document.getElementById('signals-per-sec').textContent = (data.trading.signals_per_second || 0).toFixed(2);
  document.getElementById('orders-per-sec').textContent = (data.trading.orders_per_second || 0).toFixed(2);
  document.getElementById('avg-latency').textContent = `${(data.trading.latency_ms || 0).toFixed(1)}ms`;
  document.getElementById('error-rate').textContent = `${(data.trading.error_rate || 0).toFixed(1)}%`;
  document.getElementById('success-rate').textContent = `${(data.trading.success_rate || 100).toFixed(1)}%`;

  // System info
  const uptime = data.uptime_seconds || 0;
  const hours = Math.floor(uptime / 3600);
  const minutes = Math.floor((uptime % 3600) / 60);
  document.getElementById('uptime').textContent = `${hours}h ${minutes}m`;

  document.getElementById('process-count').textContent = data.system.process_count || 0;
  document.getElementById('thread-count').textContent = data.system.thread_count || 0;
  document.getElementById('open-files').textContent = data.system.open_files || 0;

  const networkMB = ((data.system.network_sent_mb || 0) + (data.system.network_recv_mb || 0)).toFixed(1);
  document.getElementById('network-io').textContent = `${networkMB}MB`;
}

function updateProgressBarColor(elementId, value, warningThreshold, dangerThreshold) {
  const element = document.getElementById(elementId);
  if (!element) return;

  element.className = 'progress-bar';
  if (value >= dangerThreshold) {
    element.classList.add('bg-danger');
  } else if (value >= warningThreshold) {
    element.classList.add('bg-warning');
  } else {
    element.classList.add('bg-success');
  }
}

function updateCharts() {
  // Update system chart
  const systemCtx = document.getElementById('systemChart');
  if (systemCtx && performanceHistory.length > 0) {
    if (systemChart) {
      systemChart.destroy();
    }

    const labels = performanceHistory.map(h => new Date(h.timestamp).toLocaleTimeString());
    const cpuData = performanceHistory.map(h => h.cpu_percent);
    const memoryData = performanceHistory.map(h => h.memory_percent);

    systemChart = new Chart(systemCtx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'CPU %',
            data: cpuData,
            borderColor: '#4bd',
            backgroundColor: 'rgba(74, 187, 221, 0.1)',
            tension: 0.2,
            fill: false
          },
          {
            label: 'Memory %',
            data: memoryData,
            borderColor: '#17a2b8',
            backgroundColor: 'rgba(23, 162, 184, 0.1)',
            tension: 0.2,
            fill: false
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            max: 100
          }
        },
        plugins: {
          legend: { labels: { color: '#e8e8e8' } }
        }
      }
    });
  }

  // Update trading chart (placeholder - would need trading history data)
  const tradingCtx = document.getElementById('tradingChart');
  if (tradingCtx) {
    if (tradingChart) {
      tradingChart.destroy();
    }

    // Sample data for demonstration
    tradingChart = new Chart(tradingCtx, {
      type: 'bar',
      data: {
        labels: ['Signals', 'Orders', 'Errors'],
        datasets: [{
          label: 'Count',
          data: [
            document.getElementById('signals-per-sec').textContent * 60, // per minute
            document.getElementById('orders-per-sec').textContent * 60,
            parseFloat(document.getElementById('error-rate').textContent) * 60 / 100
          ],
          backgroundColor: ['#28a745', '#ffc107', '#dc3545']
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true
          }
        },
        plugins: {
          legend: { labels: { color: '#e8e8e8' } }
        }
      }
    });
  }
}

function updateBenchmarkResults(benchmarks) {
  const container = document.getElementById('benchmarkResults');
  if (!benchmarks || benchmarks.length === 0) {
    container.innerHTML = '<div class="text-muted">No benchmarks available</div>';
    return;
  }

  let html = '<div class="table-responsive"><table class="table table-dark table-sm">';
  html += '<thead><tr><th>Name</th><th>Ops/sec</th><th>Avg Latency</th><th>Duration</th><th>Memory Peak</th></tr></thead>';
  html += '<tbody>';

  benchmarks.forEach(benchmark => {
    html += `
      <tr>
        <td><strong>${benchmark.name}</strong></td>
        <td>${benchmark.operations_per_second.toFixed(0)}</td>
        <td>${benchmark.average_latency_ms.toFixed(1)}ms</td>
        <td>${benchmark.duration_seconds.toFixed(2)}s</td>
        <td>${benchmark.memory_peak_mb.toFixed(1)}MB</td>
      </tr>
    `;
  });

  html += '</tbody></table></div>';
  container.innerHTML = html;
}

function updateRecommendations(recommendations) {
  const container = document.getElementById('recommendations');
  if (!recommendations || recommendations.length === 0) {
    container.innerHTML = '<div class="text-success">System performance is optimal</div>';
    return;
  }

  let html = '<div class="list-group">';
  recommendations.forEach(rec => {
    html += `
      <div class="list-group-item bg-dark text-light border-secondary">
        <div class="d-flex align-items-center">
          <span class="status-indicator status-warning me-2"></span>
          <div>${rec}</div>
        </div>
      </div>
    `;
  });
  html += '</div>';
  container.innerHTML = html;
}

async function refreshMetrics() {
  showAlert('Refreshing metrics...', 'info');
  await loadPerformanceData();
  showAlert('Metrics refreshed successfully', 'success');
}

async function runBenchmark() {
  const name = prompt('Enter benchmark name:', 'performance_test');
  if (!name) return;

  try {
    showAlert('Running benchmark...', 'info');
    const response = await fetch(`/api/performance/benchmark/${name}?iterations=100`, {
      method: 'POST'
    });
    const result = await response.json();
    showAlert(`Benchmark completed: ${result.operations_per_second.toFixed(0)} ops/sec`, 'success');
    await loadPerformanceData(); // Refresh data
  } catch (error) {
    showAlert('Benchmark failed: ' + error.message, 'danger');
  }
}

async function saveMetrics() {
  try {
    const response = await fetch('/api/performance/metrics/save', {
      method: 'POST'
    });
    const result = await response.json();
    showAlert('Metrics saved successfully', 'success');
  } catch (error) {
    showAlert('Failed to save metrics: ' + error.message, 'danger');
  }
}

function exportPerformance() {
  // Export current performance data
  const data = {
    timestamp: new Date().toISOString(),
    performanceHistory: performanceHistory,
    tradingHistory: tradingHistory,
    currentMetrics: getCurrentMetricsFromUI()
  };

  const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `performance-${new Date().toISOString().slice(0, 10)}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function getCurrentMetricsFromUI() {
  return {
    cpu: parseFloat(document.getElementById('cpu-percent').textContent),
    memory: parseFloat(document.getElementById('memory-percent').textContent),
    disk: parseFloat(document.getElementById('disk-percent').textContent),
    signalsPerSec: parseFloat(document.getElementById('signals-per-sec').textContent),
    ordersPerSec: parseFloat(document.getElementById('orders-per-sec').textContent),
    avgLatency: parseFloat(document.getElementById('avg-latency').textContent),
    errorRate: parseFloat(document.getElementById('error-rate').textContent),
    successRate: parseFloat(document.getElementById('success-rate').textContent)
  };
}

function showAlert(message, type) {
  const alertDiv = document.createElement('div');
  alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
  alertDiv.innerHTML = `
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;

  document.body.insertBefore(alertDiv, document.body.firstChild);

  setTimeout(() => {
    if (alertDiv.parentNode) {
      alertDiv.parentNode.removeChild(alertDiv);
    }
  }, 5000);
}

// Load data on page load and refresh periodically
document.addEventListener('DOMContentLoaded', function() {
  loadPerformanceData();
  setInterval(loadPerformanceData, 30000); // Refresh every 30 seconds
});
</script>
{% endblock %}
