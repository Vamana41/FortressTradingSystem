{% extends "base.html" %}

{% block title %}Market Scanner - Fortress Trading System{% endblock %}

{% block content %}
<div class="scanner-container">
    <div class="scanner-header">
        <h1><i class="fas fa-search"></i> Market Scanner</h1>
        <p>Real-time market screening similar to ChartInk and PKScreener</p>
    </div>

    <!-- Scanner Controls -->
    <div class="scanner-controls">
        <div class="control-group">
            <label for="scanner-select">Prebuilt Scanner:</label>
            <select id="scanner-select" class="form-control">
                <option value="">Select a scanner...</option>
            </select>
        </div>

        <div class="control-group">
            <label for="symbols-input">Symbols (comma-separated):</label>
            <textarea id="symbols-input" class="form-control" rows="3"
                      placeholder="NIFTY50,BANKNIFTY,RELIANCE,TCS,INFY,HDFCBANK"></textarea>
        </div>

        <div class="control-row">
            <div class="control-group">
                <label for="timeframe-select">Timeframe:</label>
                <select id="timeframe-select" class="form-control">
                    <option value="1m">1 Minute</option>
                    <option value="5m">5 Minutes</option>
                    <option value="15m">15 Minutes</option>
                    <option value="1h">1 Hour</option>
                    <option value="4h">4 Hours</option>
                    <option value="1d" selected>1 Day</option>
                    <option value="1w">1 Week</option>
                </select>
            </div>

            <div class="control-group">
                <label>&nbsp;</label>
                <div class="button-group">
                    <button id="start-scan-btn" class="btn btn-primary">
                        <i class="fas fa-play"></i> Start Scan
                    </button>
                    <button id="stop-scan-btn" class="btn btn-danger" disabled>
                        <i class="fas fa-stop"></i> Stop
                    </button>
                </div>
            </div>
        </div>

        <div class="control-group">
            <label for="custom-rules">Custom Rules (optional):</label>
            <textarea id="custom-rules" class="form-control" rows="2"
                      placeholder="Example: rsi_14 < 30 and volume > volume_sma * 1.5"></textarea>
        </div>
    </div>

    <!-- Scanner Status -->
    <div class="scanner-status">
        <div class="status-card">
            <div class="status-item">
                <span class="status-label">Engine Status:</span>
                <span id="engine-status" class="status-value">Stopped</span>
            </div>
            <div class="status-item">
                <span class="status-label">Active Jobs:</span>
                <span id="active-jobs" class="status-value">0</span>
            </div>
            <div class="status-item">
                <span class="status-label">Total Scans:</span>
                <span id="total-scans" class="status-value">0</span>
            </div>
            <div class="status-item">
                <span class="status-label">Signals Generated:</span>
                <span id="signals-generated" class="status-value">0</span>
            </div>
        </div>

        <div class="engine-controls">
            <button id="start-engine-btn" class="btn btn-success">
                <i class="fas fa-power-off"></i> Start Engine
            </button>
            <button id="stop-engine-btn" class="btn btn-warning" disabled>
                <i class="fas fa-power-off"></i> Stop Engine
            </button>
            <button id="clear-cache-btn" class="btn btn-secondary">
                <i class="fas fa-trash"></i> Clear Cache
            </button>
        </div>
    </div>

    <!-- Active Jobs -->
    <div class="scanner-jobs">
        <h3><i class="fas fa-tasks"></i> Active Scan Jobs</h3>
        <div id="jobs-container" class="jobs-container">
            <div class="no-jobs">No active scan jobs</div>
        </div>
    </div>

    <!-- Scan Results -->
    <div class="scanner-results">
        <h3><i class="fas fa-chart-line"></i> Scan Results</h3>

        <!-- Progress Bar -->
        <div class="progress-container" id="progress-container" style="display: none;">
            <div class="progress">
                <div id="scan-progress" class="progress-bar" role="progressbar" style="width: 0%">
                    <span id="progress-text">0%</span>
                </div>
            </div>
            <div class="progress-info">
                <span id="progress-symbols">0 / 0 symbols processed</span>
                <span id="progress-time">Est. time: --</span>
            </div>
        </div>

        <!-- Results Table -->
        <div class="results-table-container">
            <table id="results-table" class="results-table">
                <thead>
                    <tr>
                        <th>Symbol</th>
                        <th>Signal</th>
                        <th>Strength</th>
                        <th>Price</th>
                        <th>RSI</th>
                        <th>Volume</th>
                        <th>Time</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="results-tbody">
                    <tr class="no-results">
                        <td colspan="8">No scan results available. Start a scan to see results.</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Results Summary -->
        <div class="results-summary">
            <div class="summary-item">
                <span class="summary-label">Buy Signals:</span>
                <span id="buy-count" class="buy-signal">0</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">Sell Signals:</span>
                <span id="sell-count" class="sell-signal">0</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">Total Results:</span>
                <span id="total-results">0</span>
            </div>
        </div>
    </div>

    <!-- Scanner Statistics -->
    <div class="scanner-stats">
        <h3><i class="fas fa-chart-bar"></i> Scanner Statistics</h3>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="avg-scan-time">0.0s</div>
                <div class="stat-label">Avg Scan Time</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="success-rate">0%</div>
                <div class="stat-label">Success Rate</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="cache-size">0</div>
                <div class="stat-label">Cache Entries</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="failed-scans">0</div>
                <div class="stat-label">Failed Scans</div>
            </div>
        </div>
    </div>
</div>

<style>
.scanner-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
}

.scanner-header {
    text-align: center;
    margin-bottom: 30px;
}

.scanner-header h1 {
    color: #2c3e50;
    margin-bottom: 10px;
}

.scanner-header p {
    color: #7f8c8d;
    font-size: 16px;
}

.scanner-controls {
    background: white;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.control-group {
    margin-bottom: 15px;
}

.control-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
    color: #2c3e50;
}

.control-row {
    display: flex;
    gap: 20px;
}

.control-row .control-group {
    flex: 1;
}

.form-control {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

.form-control:focus {
    outline: none;
    border-color: #3498db;
    box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
}

.button-group {
    display: flex;
    gap: 10px;
}

.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.2s;
}

.btn-primary {
    background: #3498db;
    color: white;
}

.btn-primary:hover {
    background: #2980b9;
}

.btn-danger {
    background: #e74c3c;
    color: white;
}

.btn-danger:hover {
    background: #c0392b;
}

.btn-success {
    background: #27ae60;
    color: white;
}

.btn-success:hover {
    background: #229954;
}

.btn-warning {
    background: #f39c12;
    color: white;
}

.btn-warning:hover {
    background: #e67e22;
}

.btn-secondary {
    background: #95a5a6;
    color: white;
}

.btn-secondary:hover {
    background: #7f8c8d;
}

.scanner-status {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: white;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.status-card {
    display: flex;
    gap: 30px;
}

.status-item {
    display: flex;
    flex-direction: column;
}

.status-label {
    font-size: 12px;
    color: #7f8c8d;
    margin-bottom: 2px;
}

.status-value {
    font-size: 16px;
    font-weight: 600;
    color: #2c3e50;
}

.engine-controls {
    display: flex;
    gap: 10px;
}

.scanner-jobs {
    background: white;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.jobs-container {
    margin-top: 15px;
}

.job-card {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 4px;
    padding: 15px;
    margin-bottom: 10px;
}

.job-header {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 10px;
}

.job-title {
    font-weight: 600;
    color: #2c3e50;
}

.job-status {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
}

.status-scanning {
    background: #3498db;
    color: white;
}

.status-completed {
    background: #27ae60;
    color: white;
}

.status-error {
    background: #e74c3c;
    color: white;
}

.job-progress {
    margin-top: 10px;
}

.progress-bar {
    height: 6px;
    background: #e9ecef;
    border-radius: 3px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: #3498db;
    transition: width 0.3s ease;
}

.scanner-results {
    background: white;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.progress-container {
    margin-bottom: 20px;
}

.progress {
    height: 20px;
    background: #e9ecef;
    border-radius: 10px;
    overflow: hidden;
    margin-bottom: 10px;
}

.progress-bar {
    height: 100%;
    background: linear-gradient(45deg, #3498db, #2980b9);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 600;
    transition: width 0.3s ease;
}

.progress-info {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    color: #7f8c8d;
}

.results-table-container {
    overflow-x: auto;
    margin-bottom: 20px;
}

.results-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
}

.results-table th {
    background: #f8f9fa;
    padding: 12px;
    text-align: left;
    font-weight: 600;
    color: #2c3e50;
    border-bottom: 2px solid #e9ecef;
}

.results-table td {
    padding: 10px 12px;
    border-bottom: 1px solid #e9ecef;
}

.results-table tr:hover {
    background: #f8f9fa;
}

.buy-signal {
    color: #27ae60;
    font-weight: 600;
}

.sell-signal {
    color: #e74c3c;
    font-weight: 600;
}

.signal-strength {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
}

.strength-high {
    background: #27ae60;
    color: white;
}

.strength-medium {
    background: #f39c12;
    color: white;
}

.strength-low {
    background: #95a5a6;
    color: white;
}

.no-results {
    text-align: center;
    color: #7f8c8d;
    font-style: italic;
}

.results-summary {
    display: flex;
    justify-content: space-around;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 4px;
}

.summary-item {
    text-align: center;
}

.summary-label {
    display: block;
    font-size: 12px;
    color: #7f8c8d;
    margin-bottom: 5px;
}

.scanner-stats {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 20px;
    margin-top: 15px;
}

.stat-card {
    text-align: center;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 4px;
}

.stat-value {
    display: block;
    font-size: 24px;
    font-weight: 700;
    color: #2c3e50;
    margin-bottom: 5px;
}

.stat-label {
    font-size: 12px;
    color: #7f8c8d;
    text-transform: uppercase;
}

.no-jobs {
    text-align: center;
    color: #7f8c8d;
    font-style: italic;
    padding: 20px;
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

@media (max-width: 768px) {
    .scanner-status {
        flex-direction: column;
        gap: 20px;
    }

    .status-card {
        flex-wrap: wrap;
        justify-content: center;
    }

    .control-row {
        flex-direction: column;
    }

    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}
</style>

<script>
class MarketScanner {
    constructor() {
        this.activeJobs = new Map();
        this.scanResults = [];
        this.prebuiltScanners = [];
        this.engineRunning = false;
        this.currentJobId = null;

        this.initializeElements();
        this.bindEvents();
        this.loadPrebuiltScanners();
        this.updateStatus();

        // Update status every 5 seconds
        setInterval(() => this.updateStatus(), 5000);
    }

    initializeElements() {
        this.elements = {
            scannerSelect: document.getElementById('scanner-select'),
            symbolsInput: document.getElementById('symbols-input'),
            timeframeSelect: document.getElementById('timeframe-select'),
            customRules: document.getElementById('custom-rules'),
            startScanBtn: document.getElementById('start-scan-btn'),
            stopScanBtn: document.getElementById('stop-scan-btn'),
            startEngineBtn: document.getElementById('start-engine-btn'),
            stopEngineBtn: document.getElementById('stop-engine-btn'),
            clearCacheBtn: document.getElementById('clear-cache-btn'),
            engineStatus: document.getElementById('engine-status'),
            activeJobs: document.getElementById('active-jobs'),
            totalScans: document.getElementById('total-scans'),
            signalsGenerated: document.getElementById('signals-generated'),
            jobsContainer: document.getElementById('jobs-container'),
            progressContainer: document.getElementById('progress-container'),
            scanProgress: document.getElementById('scan-progress'),
            progressText: document.getElementById('progress-text'),
            progressSymbols: document.getElementById('progress-symbols'),
            progressTime: document.getElementById('progress-time'),
            resultsTbody: document.getElementById('results-tbody'),
            buyCount: document.getElementById('buy-count'),
            sellCount: document.getElementById('sell-count'),
            totalResults: document.getElementById('total-results'),
            avgScanTime: document.getElementById('avg-scan-time'),
            successRate: document.getElementById('success-rate'),
            cacheSize: document.getElementById('cache-size'),
            failedScans: document.getElementById('failed-scans')
        };
    }

    bindEvents() {
        this.elements.startScanBtn.addEventListener('click', () => this.startScan());
        this.elements.stopScanBtn.addEventListener('click', () => this.stopScan());
        this.elements.startEngineBtn.addEventListener('click', () => this.startEngine());
        this.elements.stopEngineBtn.addEventListener('click', () => this.stopEngine());
        this.elements.clearCacheBtn.addEventListener('click', () => this.clearCache());

        this.elements.scannerSelect.addEventListener('change', () => {
            if (this.elements.scannerSelect.value) {
                this.loadScannerDetails(this.elements.scannerSelect.value);
            }
        });
    }

    async loadPrebuiltScanners() {
        try {
            const response = await fetch('/api/scanner/prebuilt');
            const data = await response.json();

            this.prebuiltScanners = data.scanners;
            this.populateScannerSelect();
        } catch (error) {
            console.error('Failed to load prebuilt scanners:', error);
            this.showError('Failed to load prebuilt scanners');
        }
    }

    populateScannerSelect() {
        this.elements.scannerSelect.innerHTML = '<option value="">Select a scanner...</option>';

        this.prebuiltScanners.forEach(scanner => {
            const option = document.createElement('option');
            option.value = scanner.name;
            option.textContent = scanner.name;
            option.dataset.description = scanner.description;
            this.elements.scannerSelect.appendChild(option);
        });
    }

    async loadScannerDetails(scannerName) {
        try {
            const response = await fetch(`/api/scanner/prebuilt/${scannerName}`);
            const scanner = await response.json();

            // Auto-populate symbols if available
            if (scanner.default_symbols && scanner.default_symbols.length > 0) {
                this.elements.symbolsInput.value = scanner.default_symbols.join(',');
            }

            // Set timeframe if specified
            if (scanner.default_timeframe) {
                this.elements.timeframeSelect.value = scanner.default_timeframe;
            }
        } catch (error) {
            console.error('Failed to load scanner details:', error);
        }
    }

    async startScan() {
        const scannerName = this.elements.scannerSelect.value;
        const symbolsText = this.elements.symbolsInput.value.trim();
        const timeframe = this.elements.timeframeSelect.value;
        const customRules = this.elements.customRules.value.trim();

        if (!scannerName && !customRules) {
            this.showError('Please select a prebuilt scanner or enter custom rules');
            return;
        }

        if (!symbolsText) {
            this.showError('Please enter symbols to scan');
            return;
        }

        const symbols = symbolsText.split(',').map(s => s.trim()).filter(s => s);

        try {
            const params = new URLSearchParams({
                scanner_name: scannerName || 'custom',
                symbols: symbols,
                timeframe: timeframe
            });

            if (customRules) {
                params.append('custom_rules', customRules);
            }

            const response = await fetch('/api/scanner/scan?' + params.toString(), {
                method: 'POST'
            });

            const result = await response.json();

            if (response.ok) {
                this.currentJobId = result.job_id;
                this.elements.startScanBtn.disabled = true;
                this.elements.stopScanBtn.disabled = false;
                this.showSuccess(`Scan job ${result.job_id} created successfully`);
                this.monitorJob(result.job_id);
            } else {
                throw new Error(result.detail || 'Failed to create scan job');
            }
        } catch (error) {
            console.error('Failed to start scan:', error);
            this.showError(error.message);
        }
    }

    async stopScan() {
        if (!this.currentJobId) return;

        try {
            const response = await fetch(`/api/scanner/jobs/${this.currentJobId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                this.elements.startScanBtn.disabled = false;
                this.elements.stopScanBtn.disabled = true;
                this.currentJobId = null;
                this.showSuccess('Scan job cancelled');
            }
        } catch (error) {
            console.error('Failed to stop scan:', error);
            this.showError('Failed to stop scan');
        }
    }

    async startEngine() {
        try {
            const response = await fetch('/api/scanner/start', {
                method: 'POST'
            });

            const result = await response.json();

            if (response.ok) {
                this.engineRunning = true;
                this.updateEngineControls();
                this.showSuccess('Scanner engine started successfully');
            } else {
                throw new Error(result.detail || 'Failed to start scanner engine');
            }
        } catch (error) {
            console.error('Failed to start engine:', error);
            this.showError(error.message);
        }
    }

    async stopEngine() {
        try {
            const response = await fetch('/api/scanner/stop', {
                method: 'POST'
            });

            const result = await response.json();

            if (response.ok) {
                this.engineRunning = false;
                this.updateEngineControls();
                this.showSuccess('Scanner engine stopped successfully');
            }
        } catch (error) {
            console.error('Failed to stop engine:', error);
            this.showError('Failed to stop engine');
        }
    }

    async clearCache() {
        try {
            const response = await fetch('/api/scanner/cache/clear', {
                method: 'POST'
            });

            if (response.ok) {
                this.showSuccess('Scanner cache cleared successfully');
            }
        } catch (error) {
            console.error('Failed to clear cache:', error);
            this.showError('Failed to clear cache');
        }
    }

    async updateStatus() {
        try {
            // Update engine status and statistics
            const [statsResponse, jobsResponse] = await Promise.all([
                fetch('/api/scanner/statistics'),
                fetch('/api/scanner/jobs')
            ]);

            if (statsResponse.ok && jobsResponse.ok) {
                const stats = await statsResponse.json();
                const jobs = await jobsResponse.json();

                // Update statistics
                this.elements.totalScans.textContent = stats.statistics.total_scans;
                this.elements.signalsGenerated.textContent = stats.statistics.signals_generated;
                this.elements.avgScanTime.textContent = stats.statistics.average_scan_time.toFixed(1) + 's';
                this.elements.successRate.textContent =
                    stats.statistics.total_scans > 0
                        ? ((stats.statistics.successful_scans / stats.statistics.total_scans) * 100).toFixed(1) + '%'
                        : '0%';
                this.elements.cacheSize.textContent = stats.cache_info.cache_size;
                this.elements.failedScans.textContent = stats.statistics.failed_scans;

                // Update jobs
                this.updateJobsDisplay(jobs.jobs);
                this.elements.activeJobs.textContent = jobs.count;

                // Check if engine is running based on jobs activity
                this.engineRunning = jobs.count > 0;
                this.updateEngineControls();
            }
        } catch (error) {
            console.error('Failed to update status:', error);
        }
    }

    updateEngineControls() {
        const statusElement = this.elements.engineStatus;

        if (this.engineRunning) {
            statusElement.textContent = 'Running';
            statusElement.className = 'status-value text-success';
            this.elements.startEngineBtn.disabled = true;
            this.elements.stopEngineBtn.disabled = false;
        } else {
            statusElement.textContent = 'Stopped';
            statusElement.className = 'status-value text-danger';
            this.elements.startEngineBtn.disabled = false;
            this.elements.stopEngineBtn.disabled = true;
        }
    }

    updateJobsDisplay(jobs) {
        const container = this.elements.jobsContainer;

        if (jobs.length === 0) {
            container.innerHTML = '<div class="no-jobs">No active scan jobs</div>';
            return;
        }

        container.innerHTML = jobs.map(job => this.createJobCard(job)).join('');
    }

    createJobCard(job) {
        const statusClass = `status-${job.status}`;
        const progressWidth = job.progress || 0;

        return `
            <div class="job-card">
                <div class="job-header">
                    <div class="job-title">${job.scanner_name}</div>
                    <div class="job-status ${statusClass}">${job.status.toUpperCase()}</div>
                </div>
                <div class="job-info">
                    <div>Symbols: ${job.symbols_processed} / ${job.symbols_total}</div>
                    <div>Timeframe: ${job.timeframe}</div>
                    <div>Started: ${new Date(job.start_time).toLocaleTimeString()}</div>
                </div>
                <div class="job-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progressWidth}%"></div>
                    </div>
                    <div style="font-size: 12px; color: #7f8c8d; margin-top: 5px;">
                        ${progressWidth.toFixed(1)}% complete
                    </div>
                </div>
            </div>
        `;
    }

    async monitorJob(jobId) {
        this.elements.progressContainer.style.display = 'block';

        const checkJob = async () => {
            try {
                const response = await fetch(`/api/scanner/jobs/${jobId}`);
                const job = await response.json();

                if (response.ok) {
                    this.updateProgress(job);

                    if (job.status === 'completed') {
                        this.displayResults(job.results || []);
                        this.elements.startScanBtn.disabled = false;
                        this.elements.stopScanBtn.disabled = true;
                        this.currentJobId = null;
                        this.showSuccess(`Scan completed: ${job.results_count} signals found`);
                        return; // Stop monitoring
                    } else if (job.status === 'error') {
                        this.showError(`Scan failed: ${job.error_message}`);
                        this.elements.startScanBtn.disabled = false;
                        this.elements.stopScanBtn.disabled = true;
                        this.currentJobId = null;
                        return; // Stop monitoring
                    } else if (job.status === 'cancelled') {
                        this.showInfo('Scan cancelled');
                        this.elements.startScanBtn.disabled = false;
                        this.elements.stopScanBtn.disabled = true;
                        this.currentJobId = null;
                        return; // Stop monitoring
                    }

                    // Continue monitoring
                    setTimeout(checkJob, 2000);
                }
            } catch (error) {
                console.error('Failed to monitor job:', error);
            }
        };

        checkJob();
    }

    updateProgress(job) {
        const progress = job.progress || 0;
        this.elements.scanProgress.style.width = `${progress}%`;
        this.elements.progressText.textContent = `${progress.toFixed(1)}%`;
        this.elements.progressSymbols.textContent = `${job.symbols_processed} / ${job.symbols_total} symbols processed`;

        // Estimate remaining time
        if (job.symbols_processed > 0 && job.symbols_processed < job.symbols_total) {
            const elapsed = (new Date() - new Date(job.start_time)) / 1000;
            const rate = job.symbols_processed / elapsed;
            const remaining = (job.symbols_total - job.symbols_processed) / rate;
            this.elements.progressTime.textContent = `Est. time: ${this.formatTime(remaining)}`;
        }
    }

    displayResults(results) {
        const tbody = this.elements.resultsTbody;

        if (results.length === 0) {
            tbody.innerHTML = '<tr class="no-results"><td colspan="8">No signals found for this scan.</td></tr>';
            this.updateResultsSummary(0, 0);
            return;
        }

        let buyCount = 0;
        let sellCount = 0;

        tbody.innerHTML = results.map(result => {
            if (result.signal === 'BUY') buyCount++;
            if (result.signal === 'SELL') sellCount++;

            return this.createResultRow(result);
        }).join('');

        this.updateResultsSummary(buyCount, sellCount);
    }

    createResultRow(result) {
        const signalClass = result.signal === 'BUY' ? 'buy-signal' : 'sell-signal';
        const strengthClass = this.getStrengthClass(result.strength);
        const time = new Date(result.timestamp).toLocaleTimeString();

        return `
            <tr>
                <td><strong>${result.symbol}</strong></td>
                <td class="${signalClass}">${result.signal}</td>
                <td><span class="signal-strength ${strengthClass}">${(result.strength * 100).toFixed(0)}%</span></td>
                <td>â‚¹${result.metadata.close_price?.toFixed(2) || 'N/A'}</td>
                <td>${result.metadata.rsi?.toFixed(1) || 'N/A'}</td>
                <td>${result.metadata.volume?.toLocaleString() || 'N/A'}</td>
                <td>${time}</td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="scanner.viewChart('${result.symbol}')">
                        <i class="fas fa-chart-line"></i>
                    </button>
                </td>
            </tr>
        `;
    }

    getStrengthClass(strength) {
        if (strength >= 0.8) return 'strength-high';
        if (strength >= 0.6) return 'strength-medium';
        return 'strength-low';
    }

    updateResultsSummary(buyCount, sellCount) {
        this.elements.buyCount.textContent = buyCount;
        this.elements.sellCount.textContent = sellCount;
        this.elements.totalResults.textContent = buyCount + sellCount;
    }

    formatTime(seconds) {
        if (seconds < 60) return `${Math.round(seconds)}s`;
        if (seconds < 3600) return `${Math.round(seconds / 60)}m`;
        return `${Math.round(seconds / 3600)}h`;
    }

    viewChart(symbol) {
        // Placeholder for chart viewing functionality
        this.showInfo(`Chart view for ${symbol} - Coming soon!`);
    }

    showSuccess(message) {
        this.showNotification(message, 'success');
    }

    showError(message) {
        this.showNotification(message, 'error');
    }

    showInfo(message) {
        this.showNotification(message, 'info');
    }

    showNotification(message, type) {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.textContent = message;

        // Style the notification
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 4px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            max-width: 300px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transform: translateX(100%);
            transition: transform 0.3s ease;
        `;

        // Set background color based on type
        const colors = {
            success: '#27ae60',
            error: '#e74c3c',
            info: '#3498db'
        };
        notification.style.backgroundColor = colors[type] || colors.info;

        document.body.appendChild(notification);

        // Animate in
        setTimeout(() => {
            notification.style.transform = 'translateX(0)';
        }, 100);

        // Remove after 5 seconds
        setTimeout(() => {
            notification.style.transform = 'translateX(100%)';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, 5000);
    }
}

// Initialize scanner when page loads
document.addEventListener('DOMContentLoaded', () => {
    window.scanner = new MarketScanner();
});
